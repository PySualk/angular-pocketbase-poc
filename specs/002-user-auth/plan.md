# Implementation Plan: User Authentication

**Branch**: `002-user-auth` | **Date**: 2026-02-21 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/002-user-auth/spec.md`

## Summary

Add email/password authentication to the Angular PocketBase POC using PocketBase's built-in `users` auth collection. The Angular app gains three new routes (`/auth/login`, `/auth/register`, `/auth/confirm-reset`), an `AuthService` backed by `pb.authStore` with Signal-based reactive state, and functional route guards that enforce authentication on the todo list. The `todos` collection is migrated to enforce per-user ownership via server-side collection rules. Mailpit is added to Docker Compose as a local SMTP capture server, enabling end-to-end password reset testing without a real mail provider. No third-party auth libraries are introduced.

## Technical Context

**Language/Version**: TypeScript 5.9 (strict mode)
**Primary Dependencies**: Angular 21.1, PocketBase JS SDK ^0.26.8, Tailwind CSS v4, Vitest ^4.0.8, Mailpit (local SMTP capture)
**Storage**: PocketBase SQLite (via Docker); `localStorage` for JWT session persistence (SDK default)
**Testing**: Vitest + Angular `TestBed` — all spec files colocated with implementation
**Target Platform**: Browser (SPA); PocketBase backend via Docker Compose
**Project Type**: Web application (SPA frontend + PocketBase backend)
**Performance Goals**: Sign-in and registration complete within 30–60 seconds end-to-end (SC-001, SC-002)
**Constraints**: Strict TypeScript; no `as` assertions; standalone components only; Signals for state
**Scale/Scope**: Single-user-per-session POC; one `users` auth collection, one `todos` collection

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Evidence |
|-----------|--------|---------|
| **I. KISS** | ✅ Pass | Flat file structure under `src/app/auth/`; functional guards (no class boilerplate); built-in `authStore` for session (no custom token management); `withComponentInputBinding` eliminates `ActivatedRoute` injection in `ConfirmResetComponent` |
| **II. Clean Code** | ✅ Pass | Single-responsibility: `AuthService` owns auth operations, guards own routing decisions, components own UI. Intention-revealing names throughout. No `as` assertions needed — `RecordModel` typing from SDK is sufficient |
| **III. TDD** | ✅ Pass | Each task starts with a failing test. All tasks require `npm test` passing before completion. Auth service, guards, and components each have colocated spec files |
| **IV. Minimum Code** | ✅ Pass | No extra abstractions introduced. Guards are plain functions. `AuthService` contains only the 5 operations required by the spec. No speculative extensibility |
| **V. Minimal Comments** | ✅ Pass | One comment warranted: `authStore.onChange` callback fires outside the Angular zone — same pattern and rationale as the existing SSE comment in `todo.service.ts` |
| **Standalone components** | ✅ Pass | All new components use `imports: [...]` in `@Component` |
| **Signals for state** | ✅ Pass | `AuthService` uses `signal()` + `computed()`. No RxJS subjects introduced |
| **Strict TypeScript** | ✅ Pass | No suppressions. `RecordModel | null` typing for `currentUser`. `@Input()` binding via `withComponentInputBinding` is fully typed |

No violations. Complexity Tracking table not required.

## Project Structure

### Documentation (this feature)

```text
specs/002-user-auth/
├── spec.md                          # Feature specification
├── plan.md                          # This file
├── research.md                      # Phase 0 research findings
├── data-model.md                    # Entity definitions and collection rules
├── quickstart.md                    # Developer setup guide
├── contracts/
│   └── pocketbase-auth-api.md       # PocketBase SDK call contracts
├── checklists/
│   └── requirements.md              # Specification quality checklist
└── tasks.md                         # Phase 2 task list (generated by /speckit.tasks)
```

### Source Code Changes

```text
src/
└── app/
    ├── app.ts                        # MODIFY: replace content with <router-outlet /> shell
    ├── app.config.ts                 # MODIFY: add withComponentInputBinding() to provideRouter
    ├── app.routes.ts                 # MODIFY: define all 5 routes with guards
    ├── pocketbase.service.ts         # NO CHANGE
    ├── auth/                         # NEW directory
    │   ├── auth.service.ts           # NEW: register, login, logout, resetPassword, confirmReset
    │   ├── auth.service.spec.ts      # NEW: unit tests for AuthService
    │   ├── auth.guard.ts             # NEW: authGuard + guestGuard (co-located, both small)
    │   ├── auth.guard.spec.ts        # NEW: unit tests for both guards
    │   ├── login/
    │   │   ├── login.ts              # NEW: LoginComponent (/auth/login)
    │   │   └── login.spec.ts         # NEW
    │   ├── register/
    │   │   ├── register.ts           # NEW: RegisterComponent (/auth/register)
    │   │   └── register.spec.ts      # NEW
    │   └── confirm-reset/
    │       ├── confirm-reset.ts      # NEW: ConfirmResetComponent (/auth/confirm-reset)
    │       └── confirm-reset.spec.ts # NEW
    ├── error/
    │   └── backend-error.ts          # NO CHANGE (reused by TodoListComponent)
    └── todo/
        ├── todo.ts                   # NO CHANGE
        ├── todo.service.ts           # MODIFY: add owner to create(); ngOnInit moved to TodoListComponent
        ├── todo.service.spec.ts      # MODIFY: update mock for owner field
        ├── todo-list.ts              # MODIFY: own ngOnInit load(); add user identity + logout button
        ├── todo-list.spec.ts         # MODIFY: mock AuthService
        └── todo-item.ts              # NO CHANGE

pocketbase/
└── pb_migrations/
    ├── 1_create_todos.js             # NO CHANGE
    ├── 2_add_user_auth_to_todos.js   # NEW: drop+recreate todos with owner field + scoped rules
    └── 3_configure_smtp.js           # NEW: configure PocketBase SMTP → mailpit:1025 + set app URL + reset email template

docker-compose.yml                    # MODIFY: add mailpit service (ports 1025 SMTP, 8025 web UI)
```

**Structure Decision**: Flat `src/app/auth/` directory groups all auth concerns. Sub-directories per component (`login/`, `register/`, `confirm-reset/`) follow the existing pattern (`todo/`). Guards co-located in a single `auth.guard.ts` (both are small, related functions with no reason to separate).

## Architecture Overview

### Route Table

| Path | Component | Guard | Behaviour |
|------|-----------|-------|-----------|
| `/` | `TodoListComponent` | `authGuard` | Redirects to `/auth/login` if not authenticated |
| `/auth/login` | `LoginComponent` | `guestGuard` | Redirects to `/` if already authenticated |
| `/auth/register` | `RegisterComponent` | `guestGuard` | Redirects to `/` if already authenticated |
| `/auth/confirm-reset` | `ConfirmResetComponent` | none | Reads `?token=` via `@Input()` |
| `**` | — | — | Redirects to `/` |

### AuthService API

```typescript
// State (reactive, Signal-based)
readonly currentUser: Signal<RecordModel | null>
readonly isAuthenticated: Signal<boolean>  // computed(() => currentUser() !== null)

// Operations
register(email: string, password: string, passwordConfirm: string): Promise<void>
login(email: string, password: string): Promise<void>
logout(): void
requestPasswordReset(email: string): Promise<void>
confirmPasswordReset(token: string, password: string, passwordConfirm: string): Promise<void>
```

### Guard Signatures

```typescript
// src/app/auth/auth.guard.ts
export const authGuard: CanActivateFn    // returns true or createUrlTree(['/auth/login'])
export const guestGuard: CanActivateFn   // returns true or createUrlTree(['/'])
```

### Key Implementation Notes

1. **`authStore.onChange` with `fireImmediately: true`** initialises `currentUser` signal from `localStorage` on app bootstrap — sessions survive page refresh without extra code.

2. **`AuthService.register()`** calls `pb.collection('users').create()` then immediately calls `pb.collection('users').authWithPassword()` to auto-sign-in after registration.

3. **`TodoService.create()`** must include `owner: this.pb.authStore.record!.id`. The `!` is safe here — `create()` can only be called from `TodoListComponent`, which is behind `authGuard`, so the user is always authenticated.

4. **`App` component** simplifies to `<router-outlet />`. The `ngOnInit` / `todoService.load()` logic moves to `TodoListComponent.ngOnInit`.

5. **PocketBase migration** `2_add_user_auth_to_todos.js`: resolves `users` collection ID dynamically via `app.findCollectionByNameOrId('users').id` — avoids hardcoding internal IDs.

6. **Mailpit** is added to `docker-compose.yml` as a sidecar service (`axllent/mailpit` image). It exposes port `1025` (SMTP, used by PocketBase) and port `8025` (web UI for inspecting captured emails at `http://localhost:8025`). Migration `3_configure_smtp.js` configures PocketBase to use `mailpit:1025` as its SMTP server and sets the app URL to `http://localhost:4200`, making password reset emails fully testable with `docker compose up` and zero manual steps.

## Implementation Sequence

Tasks are ordered to respect dependencies. Each task is independently testable. Full task breakdown in `tasks.md` (generated by `/speckit.tasks`).

**Group A — Backend (no Angular dependencies)**
1. `docker-compose.yml`: add Mailpit service (ports 1025 + 8025)
2. Migration `2_add_user_auth_to_todos.js`: drop and recreate `todos` with owner field + scoped rules
3. Migration `3_configure_smtp.js`: configure PocketBase SMTP → `mailpit:1025`, app URL → `http://localhost:4200`, password reset email template action URL → `{APP_URL}/auth/confirm-reset`

**Group B — Auth foundation (no UI dependencies)**
4. `AuthService`: all 5 operations + reactive `currentUser` / `isAuthenticated` signals
5. Auth guards: `authGuard` and `guestGuard`

**Group C — Routing (depends on B)**
6. Route definitions: update `app.routes.ts` with all routes and guards
7. `app.config.ts`: add `withComponentInputBinding()`
8. `App` component: simplify to `<router-outlet />`

**Group D — Auth UI (depends on B + C)**
9. `LoginComponent`: email/password form, error display, link to register and password reset
10. `RegisterComponent`: email/password/confirm form, validation, auto-login on success
11. `ConfirmResetComponent`: new-password/confirm form, token from `@Input()`, redirect on success

**Group E — Todo integration (depends on A + B + C)**
12. `TodoService`: add `owner` to `create()`; move load responsibility
13. `TodoListComponent`: own `ngOnInit`; display current user identity; add logout button
