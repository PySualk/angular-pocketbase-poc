# Data Model: User Authentication

**Feature**: 002-user-auth
**Date**: 2026-02-21

---

## Collections

### `users` (Built-in PocketBase Auth Collection)

Pre-existing. No migration required to create. The built-in `users` auth collection provides all fields below out of the box.

| Field             | Type     | Constraints                     | Notes                                  |
|-------------------|----------|---------------------------------|----------------------------------------|
| `id`              | string   | Auto-generated, unique          | PocketBase system field                |
| `email`           | email    | Required, unique                | Primary identity for login             |
| `password`        | password | Required, min 8 chars (hashed) | Never returned in API responses        |
| `passwordConfirm` | password | Required on create (matches)    | Write-only; used for registration only |
| `verified`        | bool     | Defaults to false               | Not used in this feature (deferred)    |
| `name`            | text     | Optional                        | Display name shown in UI (FR-011)      |
| `created`         | autodate | Set on create                   | System field                           |
| `updated`         | autodate | Set on create and update        | System field                           |

**Collection rules** (built-in defaults — no migration needed):

| Rule         | Value                            |
|--------------|----------------------------------|
| `listRule`   | `null` (admin only)              |
| `viewRule`   | `id = @request.auth.id`          |
| `createRule` | `""` (open — required for registration) |
| `updateRule` | `id = @request.auth.id`          |
| `deleteRule` | `id = @request.auth.id`          |

---

### `todos` (Migrated in `2_add_user_auth_to_todos.js`)

The existing `todos` collection is dropped and recreated with an `owner` relation field. All existing data is discarded.

| Field       | Type     | Constraints                              | Notes                                    |
|-------------|----------|------------------------------------------|------------------------------------------|
| `id`        | string   | Auto-generated, unique                   | PocketBase system field                  |
| `title`     | text     | Required, max 200 chars                  | Unchanged from migration 1               |
| `completed` | bool     | Defaults to false                        | Unchanged from migration 1               |
| `owner`     | relation | Required, points to `users`, maxSelect 1 | New — set to `pb.authStore.record.id` on create |
| `created`   | autodate | Set on create only                       | System field                             |
| `updated`   | autodate | Set on create and update                 | System field                             |

**Collection rules** (enforces per-user data isolation — FR-005):

| Rule         | Value                            |
|--------------|----------------------------------|
| `listRule`   | `owner = @request.auth.id`       |
| `viewRule`   | `owner = @request.auth.id`       |
| `createRule` | `@request.auth.id != ""`         |
| `updateRule` | `owner = @request.auth.id`       |
| `deleteRule` | `owner = @request.auth.id`       |

---

## Session / Auth Token

Not stored as a collection row. Managed entirely by the PocketBase SDK's `authStore`:

| Attribute | Description |
|-----------|-------------|
| `token`   | JWT issued by PocketBase on successful authentication. Short-lived (default 7 days). |
| `record`  | The authenticated `users` row (`RecordModel \| null`). |
| `isValid` | Synchronous boolean — true if token present and not expired. |

**Persistence**: Automatically stored in `localStorage` under key `pocketbase_auth`. Survives page refresh; cleared on `authStore.clear()` (logout).

---

## Password Reset Request

Not stored as a custom collection row. PocketBase manages reset tokens internally in the `users` collection's system fields.

| Attribute | Description |
|-----------|-------------|
| Token     | Time-limited, single-use string generated by PocketBase on `requestPasswordReset`. |
| Delivery  | Sent via email to the user's registered address. |
| Usage     | Consumed by `confirmPasswordReset(token, password, passwordConfirm)`. Invalid after use or expiry. |

---

## TypeScript Interfaces

### Existing (unchanged)

```typescript
// src/app/todo/todo.ts
interface Todo {
  id: string;
  title: string;
  completed: boolean;
  created: string;   // ISO 8601
  updated: string;   // ISO 8601
}
```

### New

```typescript
// src/app/auth/auth.service.ts (internal — no separate interface file needed)
// Uses RecordModel from pocketbase SDK directly:
// import type { RecordModel } from 'pocketbase';
// currentUser: Signal<RecordModel | null>
```

No new `interface` files are needed — `RecordModel` from the PocketBase SDK is sufficient for the `currentUser` signal type.

---

## State Transitions

### Authentication State Machine

```
[Unauthenticated]
      │
      ├─── register(email, pw, pwConfirm) ──► create user ──► authWithPassword ──► [Authenticated]
      │
      └─── login(email, pw) ──────────────────────────────────────────────────────► [Authenticated]

[Authenticated]
      │
      ├─── logout() ────────────────────────────────────────────────────────────► [Unauthenticated]
      │
      └─── token expires + API 401 ────────────────────────────────────────────► [Unauthenticated]

[Unauthenticated]
      │
      └─── requestPasswordReset(email) ──► email sent
                                               │
                                         user follows link
                                               │
                                         confirmPasswordReset(token, pw, pwConfirm) ──► [Unauthenticated, new password set]
```
